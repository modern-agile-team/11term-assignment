<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Todo List</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      padding: 40px;
    }

    .todo-app {
      width: 420px;
      background: #020617;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
    }

    h2 { text-align: center; margin-bottom: 16px; }

    .input-row {
      display: flex;
      gap: 8px;
    }

    input[type="text"] {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: none;
      outline: none;
      font-size: 16px;
    }

    button.add {
      padding: 0 16px;
      font-size: 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #22c55e;
      font-weight: bold;
    }

    ul {
      list-style: none;
      padding: 0;
      margin-top: 16px;
    }

    li {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      border-radius: 10px;
      transition: background 0.15s;
      cursor: pointer;
    }

    li:hover { background: #1e293b; }

    li.done span.text {
      color: #94a3b8;
      text-decoration: line-through;
      text-decoration-thickness: 2px;
    }

    span.text {
      flex: 1;
      user-select: none;
    }

    .icons span {
      cursor: pointer;
      margin-left: 6px;
      transition: transform 0.15s;
      user-select: none;
    }

    .icons span:hover {
      transform: scale(1.3);
    }

    .edit-input {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: none;
      outline: none;
      font-size: 16px;
    }

    .ok-btn {
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #38bdf8;
      font-weight: 700;
    }

    .cancel-btn {
      padding: 8px 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: #64748b;
      font-weight: 700;
      margin-left: 6px;
    }
  </style>
</head>
<body>
  <div class="todo-app">
    <h2>Todo List</h2>

    <div class="input-row">
      <input id="todoInput" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" />
      <button class="add" id="addBtn">+</button>
    </div>

    <ul id="todoList"></ul>
  </div>

<script>
  // ====== API ì„¤ì • ======
  const API_BASE = "http://localhost:3000";

  async function api(path, options = {}) {
    const res = await fetch(API_BASE + path, {
      headers: { "Content-Type": "application/json", ...(options.headers || {}) },
      ...options,
    });

    // ì„œë²„ê°€ ì—ëŸ¬ë¥¼ JSONìœ¼ë¡œ ì£¼ë“ , í…ìŠ¤íŠ¸ë¡œ ì£¼ë“  ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
    if (!res.ok) {
      const text = await res.text().catch(() => "");
      throw new Error(text || `HTTP ${res.status}`);
    }

    const contentType = res.headers.get("content-type") || "";
    if (contentType.includes("application/json")) return res.json();
    return null;
  }

  // ====== ìƒíƒœ ======
  let todos = [];           
  let editingId = null;

  const input = document.getElementById("todoInput");
  const list = document.getElementById("todoList");

  // ====== ì„œë²„ -> í™”ë©´ ======
  function render() {
    list.innerHTML = "";

    todos.forEach((todo) => {
      const li = document.createElement("li");
      li.dataset.id = String(todo.id);
      if (todo.done) li.classList.add("done");

      li.addEventListener("click", () => {
        if (editingId === todo.id) return; 
        toggleTodo(todo.id);
      });

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = todo.done;
      checkbox.addEventListener("click", (e) => {
        e.stopPropagation();
        toggleTodo(todo.id);
      });

      const text = document.createElement("span");
      text.className = "text";
      text.textContent = todo.text;

      const icons = document.createElement("div");
      icons.className = "icons";

      const edit = document.createElement("span");
      edit.textContent = "âœï¸";
      edit.className = "edit";
      if (todo.done) edit.style.display = "none";
      edit.addEventListener("click", (e) => {
        e.stopPropagation();
        startEdit(todo.id);
      });

      const del = document.createElement("span");
      del.textContent = "ğŸ—‘ï¸";
      del.addEventListener("click", (e) => {
        e.stopPropagation();
        deleteTodo(todo.id);
      });

      icons.append(edit, del);
      li.append(checkbox, text, icons);
      list.append(li);
    });
  }
  // GET /todos
  async function loadTodos() {
    // ë°±ì—”ë“œ ì‘ë‹µ: [{ id, description, is_check, in_date }, ...]
    const rows = await api("/todos");
    todos = rows.map((r) => ({
      id: r.id,
      text: r.description,
      done: Number(r.is_check) === 1,
      in_date: r.in_date,
    }));
    render();
  }

  // POST /todos
  async function addTodo() {
    const value = input.value.trim();
    if (!value) {
      alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    // ì„œë²„ì— ìƒì„± ìš”ì²­
    await api("/todos", {
      method: "POST",
      body: JSON.stringify({ description: value }),
    });

    input.value = "";
    await loadTodos();
  }

  // PATCH /todos/:id
  async function toggleTodo(id) {
    const todo = todos.find((t) => t.id === id);
    if (!todo) return;

    // ì™„ë£Œ/ë¯¸ì™„ë£Œ
    const next = todo.done ? 0 : 1;

    await api(`/todos/${id}`, {
      method: "PATCH",
      body: JSON.stringify({ is_check: next }),
    });

    await loadTodos();
  }

  // DELETE /todos/:id
  async function deleteTodo(id) {
    if (editingId === id) editingId = null;

    await api(`/todos/${id}`, { method: "DELETE" });
    await loadTodos();
  }

  // ìˆ˜ì • ì‹œì‘
  function startEdit(id) {
    const todo = todos.find((t) => t.id === id);
    if (!todo) return;

    if (todo.done) {
      alert("ì™„ë£Œëœ í•­ëª©ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    if (editingId !== null && editingId !== id) {
      alert("ë‹¤ë¥¸ í•­ëª©ì„ ìˆ˜ì • ì¤‘ì…ë‹ˆë‹¤. ë¨¼ì € ì™„ë£Œ/ì·¨ì†Œí•˜ì„¸ìš”.");
      return;
    }
    editingId = id;

    const li = [...list.children].find((el) => Number(el.dataset.id) === id);
    li.innerHTML = "";

    const inputEdit = document.createElement("input");
    inputEdit.className = "edit-input";
    inputEdit.value = todo.text;
    inputEdit.focus();

    const ok = document.createElement("button");
    ok.className = "ok-btn";
    ok.textContent = "ì™„ë£Œ";
    ok.addEventListener("click", (e) => {
      e.stopPropagation();
      finishEdit(id, inputEdit.value);
    });

    const cancel = document.createElement("button");
    cancel.className = "cancel-btn";
    cancel.textContent = "ì·¨ì†Œ";
    cancel.addEventListener("click", (e) => {
      e.stopPropagation();
      editingId = null;
      render();
    });

    inputEdit.addEventListener("keydown", (e) => {
      if (e.key === "Enter") finishEdit(id, inputEdit.value);
    });

    li.append(inputEdit, ok, cancel);
  }

  // PATCH /todos/:id (ë‚´ìš© ìˆ˜ì •)
  async function finishEdit(id, newText) {
    const v = (newText || "").trim();
    if (!v) {
      alert("ë¹ˆ ê°’ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    await api(`/todos/${id}`, {
      method: "PATCH",
      body: JSON.stringify({ description: v }),
    });

    editingId = null;
    await loadTodos();
  }

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  document.getElementById("addBtn").addEventListener("click", addTodo);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") addTodo();
  });

  // ì‹œì‘
  (async function main() {
    try {
      await loadTodos();
    } catch (e) {
      console.error(e);
      alert(
        "ì„œë²„ ì—°ê²° ì‹¤íŒ¨!\n" +
        "1) ë°±ì—”ë“œê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸ (npm run dev)\n" +
        "2) ì£¼ì†Œê°€ http://localhost:3000 ì¸ì§€ í™•ì¸\n\n" +
        "ì—ëŸ¬: " + e.message
      );
    }
  })();
</script>
</body>
</html>
